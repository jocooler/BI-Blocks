<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <link rel="stylesheet" href="sandstone-bootstrap.min.css">
    <link rel="stylesheet" href="c3.css">
	<style>
		.img-inline {
			float:left;
			margin:8px;
			max-width:100%;
		}
		.show-short .extended {
			display:none;
		}
		.show-extended .short {
			display:none;
		}
		.show-nano .short, .show-nano .extended {
			display:none;
		}
		.editHandle {
			color: #ccc;
			position: absolute;
			top: 5px;
			right: 25px;
			z-index: 20;
			cursor: pointer;
			opacity:0;
			display:none;
			transition:opacity 300ms;
		}
		.brick:hover .editHandle {
			display:block;
			opacity:1;
		}
	</style>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.3.7/js/tether.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/js/bootstrap.min.js"></script>
	<script src="scripts/mustache.js"></script>
  </head>
  
  <body>
	<!-- Modal -->
	<div class="modal fade" id="editDescription">
	  <div class="modal-dialog" role="document">
		<div class="modal-content">
		  <div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-label="Close">
			  <span aria-hidden="true">&times;</span>
			</button>
			<h4 class="modal-title">Edit</h4>
		  </div>
		  <div class="modal-body">
			<div class="form-group">
				<label for="shortInput">Short Description</label>
				<textarea class="form-control" id="shortInput" maxlength="250" rows="2"></textarea>
			</div>
			<div class="form-group">
				<label for="extendedInput">Long Description</label>
				<textarea class="form-control" id="extendedInput" rows="7"></textarea>
			</div>
		  </div>
		  <div class="modal-footer">
			<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
			<button type="button" class="btn btn-primary" data-dismiss="modal" id="saveDescriptions">Save changes</button>
		  </div>
		</div>
	  </div>
	</div>
  
	<div class="container-fluid">		
		<div class="row">
		
		
		</div>
	</div>

	<script>
	var columns = 0,
		target = '',
		API_KEY = 'd1b885b8d202ab320717b54d9265e360db151e69be811f38da2f24fdd09333a5',
		VTRANS_API = 'https://vtransapi.aot.state.vt.us/api/v2/';
		
	function getView(name, callback) {
		$.get(VTRANS_API + "legos/_table/views?fields=*&related=*&filter=view%3D" + name + "&api_key=" + API_KEY, function (response) {
			$.each(response.resource, function (i, r) {
				var block = {
					order: r.layout_order,
					className: r.className + " show-short",
					title: r.blocks.name,
					template: r.blocks.template,
					query: r.blocks.query,
					short: r.blocks.short,
					extended: r.blocks.extended,
					tags: [], 
					blockId: 'block' + Math.random().toString().substring(4) + "-" + Math.random().toString().substring(3)
				};
				
				$.each(r.tags, function (i, tag) {
					block.tags.push(tag.tag);
				});
				callback(block);
			});
		});
	}
	
	var blocks = getView("Demo View 1", function(block) { // THIS IS WHAT NEEDS TO CHANGE TODO
		$.get(block.template, function (template) {
			console.log(template, block);
			createBrick(template, block);
		});
	});
	
	function createBrick(template, brick, attachmentPoint) {
		var size = brick.className.replace(/\D/, ' '); // TODO - parse size out of col-*-size. TODO - different screen sizes
		console.log(size, brick.className);
		if (size + columns > 12) {
			$('body .container-fluid').append('<div class="row">');
			columns = 0;
		}
		
		if (!attachmentPoint) {
			var attachmentPoint = 'body .container-fluid>.row:last-of-type';
		}
		
		var $html = $(Mustache.render(template, brick));
		$(attachmentPoint).append($html);
		attachEditorListener($html);
		columns += size; // need to parse this out of sizes and consider larger screens maybe.
		
		
	}
	
	function createRow() {
		$('body .container-fluid').append('<div class="row">');
	}
	
	function showExtended(el) {
		var $el = $(el).parents('.brick');
		$el.removeClass('show-nano').removeClass('show-short').addClass('show-extended');
		$el.css('width','100%');
		setTimeout(function () {
			$('html, body').animate({
				scrollTop: $el.offset().top
			}, 300);
		},
		400);
		
	}
	
	function showShort(el) {
		var $el = $(el).parents('.brick');
		$el.removeClass('show-nano').addClass('show-short').removeClass('show-extended');
		$el.css('width','');
	}
	
	function showNano(el) {
		var $el = $(el).parents('.brick');
		$el.addClass('show-nano').removeClass('show-short').removeClass('show-extended');
		$el.css('width','');
	}
	
	function changeSize(el) {
		var val = $(el).val(),
			$el = $(el).parents('.brick');
		if (val < 1) {
			val = 1;
		} else if (val > 12) {
			val = 12;
		}
		$(el).val(val);
		$el.alterClass('col-*', 'col-md-' + val);
		changeLayout($el);
	}
	
	function editDescription(el) {
		var $el = $(el).parents('.brick');
		var s = $('.short', $el).html();
		var e = $('.extended', $el).html();
		var $editor = $('#editDescription');
		target = $el;
		
		$('#shortInput').val(s);
		$('#extendedInput').val(e);
		$editor.modal();
	}
	
	$('#saveDescriptions').click(function() {
			$('.short', target).html($('#shortInput').val());
			$('.extended', target).html($('#extendedInput').val());
		});
	
	function changeLayout($el) {
		// redraw any charts
		
		$('.c3', $el).each(function() { $(this).data('c3-chart').flush(); });
		
		// reflow the page
	
		columns = 12; //force a new collection first thing.
		var collections = [];
		$('.brick').unwrap('.row');
		
		$('.brick').each(function (i, e) {
			var w = e.className.match(/col-md-(\d+)/i);
			w = parseInt(w[1]) || false;

			if (columns + w > 12) {
				collections.push([e]);
				columns = w;
			} else {
				collections[collections.length - 1].push(e)
				columns += w;
			}
			
		});

		
		for (var i = 0; i< collections.length; i++) {
			var v = collections[i],
				row = document.createElement('div');
			row.className = 'row';
			wrapAll(v, row);
		};
	}

	
	
// Wrap wrapper around nodes
// Just pass a collection of nodes, and a wrapper element
function wrapAll(nodes, wrapper) {
    // Cache the current parent and previous sibling of the first node.
    var parent = nodes[0].parentNode;
    var previousSibling = nodes[0].previousSibling;

    // Place each node in wrapper.
    //  - If nodes is an array, we must increment the index we grab from 
    //    after each loop.
    //  - If nodes is a NodeList, each node is automatically removed from 
    //    the NodeList when it is removed from its parent with appendChild.
    for (var i = 0; nodes.length - i; wrapper.firstChild === nodes[0] && i++) {
        wrapper.appendChild(nodes[i]);
    }

    // Place the wrapper just after the cached previousSibling,
    // or if that is null, just before the first child.
    var nextSibling = previousSibling ? previousSibling.nextSibling : parent.firstChild;
    parent.insertBefore(wrapper, nextSibling);

    return wrapper;
}
	
/**
 * jQuery alterClass plugin
 *
 * Remove element classes with wildcard matching. Optionally add classes:
 *   $( '#foo' ).alterClass( 'foo-* bar-*', 'foobar' )
 *
 * Copyright (c) 2011 Pete Boere (the-echoplex.net)
 * Free under terms of the MIT license: http://www.opensource.org/licenses/mit-license.php
 *
 */
(function ( $ ) {
	
$.fn.alterClass = function ( removals, additions ) {
	
	var self = this;
	
	if ( removals.indexOf( '*' ) === -1 ) {
		// Use native jQuery methods if there is no wildcard matching
		self.removeClass( removals );
		return !additions ? self : self.addClass( additions );
	}

	var patt = new RegExp( '\\s' + 
			removals.
				replace( /\*/g, '[A-Za-z0-9-_]+' ).
				split( ' ' ).
				join( '\\s|\\s' ) + 
			'\\s', 'g' );

	self.each( function ( i, it ) {
		var cn = ' ' + it.className + ' ';
		while ( patt.test( cn ) ) {
			cn = cn.replace( patt, ' ' );
		}
		it.className = $.trim( cn );
	});

	return !additions ? self : self.addClass( additions );
};

})( jQuery );

						
	</script>
  </body>
</html>

