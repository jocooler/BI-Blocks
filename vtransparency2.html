<!doctype html>
<html>
<head>
<link rel="stylesheet" href="sandstone-bootstrap.min.css" />
<link rel="stylesheet" href="c3.css" />
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
</head>
<body>

	<style>
		.img-inline {
			float:left;
			margin:8px;
			max-width:100%;
		}
		.show-short .extended {
			display:none;
		}
		.show-extended .short {
			display:none;
		}
		.show-nano .short, .show-nano .extended {
			display:none;
		}
		.editHandle {
			color: #ccc;
			position: absolute;
			top: 5px;
			right: 25px;
			z-index: 20;
			cursor: pointer;
			opacity:0;
			display:none;
			transition:opacity 300ms;
		}
		.brick:hover .editHandle {
			display:block;
			opacity:1;
		}
		.card {
			box-shadow: 0px 0px 5px black;
			background-color: rgba(255,255,255,0.9);
		}
		#searchBoxWrap {
			margin:0 auto;
			max-width:600px;
		
		}
	</style>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.3.7/js/tether.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/js/bootstrap.min.js"></script>
	<script src="scripts/mustache.js"></script>
	<script src="scripts/d3.min.js"></script>
	<script src="scripts/c3.js"></script>
  </head>
  
  <body>
	<div class="container-fluid">
		<div class="row">
			<h2 class="text-center">What are you looking for?</h2>
			<div class="input-group input-group-lg" id="searchBoxWrap">
				
				<input type="text" class="form-control" placeholder="pavement" aria-describedby="sizing-addon1">
				<span class="input-group-addon" id="sizing-addon1"><i class='fa fa-search'></i></span>
			</div>
			<br />
			<div class="button-wrap" style="text-align:center;">
				<p>
					<input type="button" class="btn btn-primary btn-sm" value="network"/>
					<input type="button" class="btn btn-primary btn-sm" value="safety"/>
					<input type="button" class="btn btn-primary btn-sm" value="projects"/>
					<input type="button" class="btn btn-primary btn-sm" value="maintenance"/>
					<input type="button" class="btn btn-primary btn-sm" value="pavement"/>
					<input type="button" class="btn btn-primary btn-sm" value="bridges"/>
					<input type="button" class="btn btn-primary btn-sm" value="crashes"/>
					<input type="button" class="btn btn-primary btn-sm" value="winter"/>
					<input type="button" class="btn btn-primary btn-sm" value="pedestrian"/>
					<input type="button" class="btn btn-primary btn-sm" value="rail"/>
				</p>
			</div>
		</div>
		<br />
		<div class="row">
		
		
		</div>
	</div>
	<script>
	var template = `<h4>{{title}}</h4> <hr /> <div class="card-text" id="block{{blockid}}"> <div class="row"> <div class="chart"></div> </div> <p class="card-text short">{{short}}</p> <p class="card-text extended">{{{extended}}}</p> </div> </div> <div class="card-footer"> <small class="text-muted">{{updated}}</small> </div> <script> var attachments = { init: function () { var urls = {{#url}} {{{url}}} {{/url}} {{^url}} false {{/url}}, promises = [], self = this; if (!urls) return false; $.each(urls, function (k, v) { promises.push(new Promise(function(resolve, reject) { $.get(v, function(d) { var ret = {name: k, data: d}; resolve(ret); }).fail(function(e) { var ret = {name: k, error: e}; reject(ret); }); })); }); Promise.all(promises).then(function (data) { var ret = {}; $.each(data, function (i, v) { ret[v.name] = v.data; }); self.drawChart(ret); }).catch(function (e) { console.log(e); }); }, drawChart: function (raw) { var data = []; $.each(raw, function (k, v) { var o = [k]; $.each(v.resource, function (j, w) { $.each(w, function (k, val) { o.push(val); }); }); data.push(o); }); var chart = c3.generate({ data: { columns: data, type: '{{type}}' }, bar: { width: { ratio: 0.5 } }, axis: { x: { type: 'category' }, y: { show: false } }, bindto: '#block{{blockid}} .chart' }); $('#block{{blockid}} .chart').data('c3-chart', chart); } }; $('#block{{blockid}}').data('block', attachments);<` + '/script>';
	</script>
  <script>
  var columns = 0,
		target = '';
	function createBrick() {
		//overloaded
		// ([html] content, [{}] options)
		// ([.row] attachmentPoint, [html] content, [{}] options)
		if (arguments.length = 2){
			var row = 'body .container-fluid>.row:last-of-type',
				content = arguments[0],
				options = arguments[1];
		} else {
			var row = arguments[0],
				content = arguments[1],
				options = arguments[2];
		}
		if (!options) options = {};
		if (!options.show) options.show = "show-short";
		if (!options.size) options.size = 6;
		
		if (options.size + columns > 12) {
			$('body .container-fluid').append('<div class="row">');
			columns = 0;
		}
		
		content = Mustache.render(content, options);
		var $html = $(Mustache.render('<div class="brick col-md-{{options.size}} {{options.show}}"><div class="card"><div class="card-block">{{{content}}}</div></div></div>', {content: content, options:options}));
		$(row).append($html);
		//attachEditorListener($html);
		columns += options.size;
		
		return $html;
	}
	
	function createRow() {
		var $row = $('<div class="row">');
		$('body .container-fluid').append($row);
		return $row;
	}
	
	function attachEditorListener($el) {

		$handle = $('<div class="btn-group editHandle"><button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">edit</button><div class="dropdown-menu dropdown-menu-right"><button class="dropdown-item" href="#" onclick="showExtended(this)">Show Extended</button><button class="dropdown-item" href="#" onclick="showShort(this)">Show Short</button><button class="dropdown-item" href="#" onclick="showNano(this)">Show Nano</button><button class="dropdown-item">Change Size: <input type="number" value="6" min="1" max="12" style="width:30px" onchange="changeSize(this)"/></button><div class="dropdown-divider"></div><button class="dropdown-item" href="#" onclick="editDescription(this)">Edit Description</button></div></div>');
		
		$el.prepend($handle);
	}
	
	function showExtended(el) {
		var $el = $(el).parents('.brick');
		$el.removeClass('show-nano').removeClass('show-short').addClass('show-extended');
	}
	
	function showShort(el) {
		var $el = $(el).parents('.brick');
		$el.removeClass('show-nano').addClass('show-short').removeClass('show-extended');
	}
	
	function showNano(el) {
		var $el = $(el).parents('.brick');
		$el.addClass('show-nano').removeClass('show-short').removeClass('show-extended');
	}
	
	function changeSize(el) {
		var val = $(el).val(),
			$el = $(el).parents('.brick');
		if (val < 1) {
			val = 1;
		} else if (val > 12) {
			val = 12;
		}
		$(el).val(val);
		$el.alterClass('col-*', 'col-md-' + val);
		changeLayout($el);
	}
	
	function editDescription(el) {
		var $el = $(el).parents('.brick');
		var s = $('.short', $el).html();
		var e = $('.extended', $el).html();
		var $editor = $('#editDescription');
		target = $el;
		
		$('#shortInput').val(s);
		$('#extendedInput').val(e);
		$editor.modal();
	}
	
	$('#saveDescriptions').click(function() {
			$('.short', target).html($('#shortInput').val());
			$('.extended', target).html($('#extendedInput').val());
		});
	
	function changeLayout($el) {
		// redraw any charts
		
		$('.c3', $el).each(function() { $(this).data('c3-chart').flush(); });
		
		// reflow the page
	
		columns = 12; //force a new collection first thing.
		var collections = [];
		$('.brick').unwrap('.row');
		
		$('.brick').each(function (i, e) {
			var w = e.className.match(/col-md-(\d+)/i);
			w = parseInt(w[1]) || false;

			if (columns + w > 12) {
				collections.push([e]);
				columns = w;
			} else {
				collections[collections.length - 1].push(e)
				columns += w;
			}
			
		});

		
		for (var i = 0; i< collections.length; i++) {
			var v = collections[i],
				row = document.createElement('div');
			row.className = 'row';
			wrapAll(v, row);
		};
	}

	
	
// Wrap wrapper around nodes
// Just pass a collection of nodes, and a wrapper element
function wrapAll(nodes, wrapper) {
    // Cache the current parent and previous sibling of the first node.
    var parent = nodes[0].parentNode;
    var previousSibling = nodes[0].previousSibling;

    // Place each node in wrapper.
    //  - If nodes is an array, we must increment the index we grab from 
    //    after each loop.
    //  - If nodes is a NodeList, each node is automatically removed from 
    //    the NodeList when it is removed from its parent with appendChild.
    for (var i = 0; nodes.length - i; wrapper.firstChild === nodes[0] && i++) {
        wrapper.appendChild(nodes[i]);
    }

    // Place the wrapper just after the cached previousSibling,
    // or if that is null, just before the first child.
    var nextSibling = previousSibling ? previousSibling.nextSibling : parent.firstChild;
    parent.insertBefore(wrapper, nextSibling);

    return wrapper;
}
var blockid = 100;
var t = Mustache.render(
	template, 
	{
		title: "Public Transit",
		blockid: blockid++,
		short: "The number of Vermonters who rode the bus or used other public transit rose to nearly 30% for the first time in 2016.",
		extended: 'The number of Vermonters who rode the bus or used other public transit rose to nearly 30% for the first time in 2016. <br /> <a class="btn btn-primary btn-sm" href="#" role="button">Learn more</a>',
		url: `{
			"Didn't": 'https://vtransapi.aot.state.vt.us/api/v2/edh/_table/closures?fields=duration&filter=(duration>0)%20AND%20(duration<100) &api_key=d1b885b8d202ab320717b54d9265e360db151e69be811f38da2f24fdd09333a5',
			'Used Public Transit in 2016':'https://vtransapi.aot.state.vt.us/api/v2/edh/_table/closures?fields=duration&filter=duration>100&api_key=d1b885b8d202ab320717b54d9265e360db151e69be811f38da2f24fdd09333a5'
		}`,
		type: "pie",
		updated: "Last modified 2/1/2017."
	}
);
var el = createBrick(
	t,
	{size:4, show: "show-short"}
);
$('.card-text', el).data('block').init();

el = createBrick(Mustache.render(template, {
	title: "Highway Safety",
	blockid: blockid++,
	short: "The Highway Safety Section is renowned for its tongue twisting acronyms...",
	extended: '<p>The Highway Safety Section is renowned for its tongue twisting acronyms...</p> <br /> <a class="btn btn-primary btn-sm" href="#" role="button">Learn more about GHHHSP</a>',
	url: '',
	type: "bar",
	updated: "Last modified 2/1/2017."
}), {size:4, show: "show-extended"});
$('.card-text', el).data('block').init();



$.get('templates/pavementCondition.html', function (template){
	el = createBrick(Mustache.render(template, {
		title: "Pavement Condition",
		blockid: blockid++,
		short: "",
		extended: 'Pavement Conditions are a great way to measure how we\'re doing with our roads. Everyone likes good roads; unfortunately, we have too many.<br /> <a class="btn btn-primary btn-sm" href="#" role="button">Learn more</a>',
		updated: "Last modified 2/7/2017."
	}), {size:4, show: "show-extended"});
	$('.card-text', el).data('block').init();
});


$.get('templates/pavementConditionTWAC.html', function (template){
	el = createBrick(Mustache.render(template, {
		title: "Travel Weighted Pavement Condition",
		blockid: blockid++,
		short: "",
		extended: 'Our roads are the best in the universe, far outstripping Luxembourg and Sealand for both quality and customer satisfaction.<br /> <a class="btn btn-primary btn-sm" href="#" role="button">Learn more</a>',
		updated: "Last modified 2/7/2017."
	}), {size:4, show: "show-extended"});
	$('.card-text', el).data('block').init();
});


/**
 * jQuery alterClass plugin
 *
 * Remove element classes with wildcard matching. Optionally add classes:
 *   $( '#foo' ).alterClass( 'foo-* bar-*', 'foobar' )
 *
 * Copyright (c) 2011 Pete Boere (the-echoplex.net)
 * Free under terms of the MIT license: http://www.opensource.org/licenses/mit-license.php
 *
 */
(function ( $ ) {
	
$.fn.alterClass = function ( removals, additions ) {
	
	var self = this;
	
	if ( removals.indexOf( '*' ) === -1 ) {
		// Use native jQuery methods if there is no wildcard matching
		self.removeClass( removals );
		return !additions ? self : self.addClass( additions );
	}

	var patt = new RegExp( '\\s' + 
			removals.
				replace( /\*/g, '[A-Za-z0-9-_]+' ).
				split( ' ' ).
				join( '\\s|\\s' ) + 
			'\\s', 'g' );

	self.each( function ( i, it ) {
		var cn = ' ' + it.className + ' ';
		while ( patt.test( cn ) ) {
			cn = cn.replace( patt, ' ' );
		}
		it.className = $.trim( cn );
	});

	return !additions ? self : self.addClass( additions );
};

})( jQuery );
  </script>
  </body>