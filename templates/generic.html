<!--
{
	title: "Demo Block",
	blockid: 27,
	short: "This is how a block works.",
	extended: "A block works in this wise: some stuff happens and then other stuff happens.",
	url: [
		'https://vtransapi.aot.state.vt.us/api/v2/edh/_table/closures?fields=duration&filter=duration>0&api_key=d1b885b8d202ab320717b54d9265e360db151e69be811f38da2f24fdd09333a5'
	],
	type: "bar"
}

-->
<h4>{{title}}</h4>
<hr />
<div class="card-text" id="block{{blockid}}">
	<div class="row">
		<div class="chart"></div>
	</div>
	<p class="card-text short">{{short}}</p>
	<p class="card-text extended">{{{extended}}}</p>
</div>
</div> 
<div class="card-footer">
  <small class="text-muted">Last updated 3 mins ago</small>
</div>

<script>
function init{{blockid}} () {
	var urls = [
	{{#url}}
		"{{{.}}}",
	{{/url}}
	],
		promises = [];

	for (var i = 0; i<urls.length; i++) {
		var u = urls[i];
		promises.push(new Promise(function(resolve, reject) {
			$.get(u, function(d) {
				resolve(d);
			}).fail(function(e) {reject(e)});
		}));
	}

	Promise.all(promises).then(function (data) {
		//success!
		drawChart(data);
	}).catch(function (e) {
		//failed.
		console.log(e);
	});
}

function drawChart(raw) {
	var data = [];
	$.each(raw, function (i, v) {
		var o = [];
		$.each(v.resource, function (j, w) {
			$.each(w, function (k, val) {
				o.push(val);
			});
		});
		data.push(o);
	});
	var chart = c3.generate({ 
		data: { 
			columns: data, 
			type: '{{type}}' 
		}, 
		bar: { 
			width: { 
				ratio: 0.5 // this makes bar width 50% of length between ticks 
			} 
		}, 
		axis: { 
			x: { 
				type: 'category' // this needed to load string x value 
			}, 
			y: { show: false } 
		}, 
		bindto: '#block{{blockid}} .chart' 
	}); 
	$('#block{{blockid}} .chart').data('c3-chart', chart); 
}

init{{blockid}}();
</script>
<!--
$.get('http://vtransdream.vtransweb.aot.state.vt.us/api/v2/edh/_table/closures?filter=duration>0&api_key=d1b885b8d202ab320717b54d9265e360db151e69be811f38da2f24fdd09333a5', function (data) { 
	// This year's Closure Duration 
	var closures = {}; 
	var temp = []; 
	var x = ['x']; // axis titles 
	var values = ['2016 Number of Closures']; // values & legend name 
	$.each(data.resource, function (i, v) { // filter to just this year 
		if (v.Duration && v.CloseDate.indexOf('2016') > -1) { 
			closures[v.Duration] = closures[v.Duration] + 1 || 1; 
		} 
	}); 
	$.each(closures, function(k, v) { // prep for sorting 
		temp.push({duration: k, count: v}); 
	}); 
	temp.sort(function (a, b) { // sort together 
		if (a.duration > b.duration) { 
			return 1; 
		} else if (a.duration < b.duration) { 
			return -1; 
		} else { 
			return 0; 
		} 
	}); 
	$.each(temp, function (i, v) { // split sorted objects into arrays 
		x.push(v.duration + ' Days'); 
		values.push(v.count); 
	}); 
	var chart = c3.generate({ 
		data: { 
			x : 'x', 
			columns: [ x, values ], 
			type: 'bar' 
		}, 
		bar: { 
			width: { 
				ratio: 0.5 // this makes bar width 50% of length between ticks 
			} 
		}, 
		axis: { 
			x: { 
				type: 'category' // this needed to load string x value 
			}, 
			y: { show: false } 
		}, 
		bindto: '#chart2' 
	}); 
	$('#chart2').data('c3-chart', chart); 
		
	// total closure length over time. 
	var totalClosures = {}; 
	$.each(data.resource, function (i, v) { 
		var year = new Date(v.CloseDate).getFullYear(); 
		totalClosures[year] = totalClosures[year] + v.Duration || v.Duration; 
	}); 
	var years = Object.keys(totalClosures).sort();
	var total = [];
	$.each(years, function (i, v) { total.push(totalClosures[v]); }); 
	years = ['Years'].concat(years); 
	total = ['Days Closed'].concat(total); 
	chart = c3.generate({ 
		data: { 
				x : 'Years', 
				columns: [ years, total ], 
				type: 'bar' 
			}, 
		bar: { 
			width: { 
				ratio: 0.5 // this makes bar width 50% of length between ticks 
			} 
		}, 
		axis: { 
			x: { 
				type: 'category' // this needed to load string x value 
			},
			y: { show: false } 
		}, 
		bindto: '#chart3' 
	}); 
	$('#chart3').data('c3-chart', chart); 
});-->